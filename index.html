<!doctype html>
<html lang="ru">
    <head>
        <!-- Обязательные метатеги -->
        <title>Шахматка</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" 
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
        <link rel="stylesheet" href="./plugins/resizeEverything/resizeEverything.css">
        <link rel="stylesheet" href="./css/main.css">
    </head>
    <body>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
        <script src="./plugins/moment/moment.js"></script>
        <script src="./plugins/jq/jquery.js"></script>
        <script src="./plugins/resizeEverything/resizeEverything.js"></script>
        <script src="./js/js.js"></script>

        <!-- Просто блок в который помещаю элементы -->
        <section id="container" class="container mt-4"></section>
    </body>
    <script>
    $(document).click((e) => {
        // let date = new Date('05.01.2023 12:30:01')
        // console.log(date)

        // date.setMinutes(date.getMinutes() + 32154)
        // console.log(date)

        // console.log(window.innerWidth)
        // console.log(e.pageX)

        // console.log($('.DaysContainer').position().left)
        // console.log($('.DaysContainer').position().left + $('.DaysContainer').width())
    })
    //#region scheduleParam

    //Места (Объекты левой колонки)
    var locations = [
        {
            id: 1,
            name: "Paris"
        },
        {
            id: 2,
            name: "London"
        },
        {
            id: 3,
            name: "Moscow"
        },
        {
            id: 4,
            name: "Berlin"
        },
        {
            id: 5,
            name: "Rostov"
        },
        {
            id: 6,
            name: "Kazan"
        },
        {
            id: 7,
            name: "Vladivostok"
        }
    ];

    //События (полоски в табличке)
    var events = [
        {
            id: 1,
            locationId: 1,
            name: "EventName1",
            extClass: "",
            start: moment().add('1','day').startOf('day').hour(9),
            end: moment().add('2','day').startOf('day').hour(9).add('4','hour')
        },
        {
            id: 2,
            locationId: 1,
            name: "EventName2",
            extClass: "",
            start: moment().add('1','day').startOf('day').hour(12),
            end: moment().add('2','day').startOf('day').hour(12)
        },
        {
            id: 7,
            locationId: 2,
            name: "01-23",
            extClass: "",
            start: moment().add('1','day').startOf('day').hour(01),
            end: moment().add('1','day').startOf('day').hour(23)
        },
        {
            id: 3,
            locationId: 2,
            name: "Мероприятие ранее сетки",
            extClass: "",
            start: moment().add('-1','day').startOf('day').hour(12),
            end: moment().add('2','day').startOf('day').hour(12)
        },
        {
            id: 4,
            locationId: 3,
            name: "Мероприятие позднее сетки",
            extClass: "",
            start: moment().add('4','day').startOf('day').hour(3),
            end: moment().endOf('day').add('8', 'day')
        },
        {
            id: 5,
            locationId: 4,
            name: "Мероприятие на всю ширину ровно",
            extClass: "",
            start: moment().startOf('day'),
            end: moment().endOf('day').add('5', 'day'),
        },
        {
            id: 6,
            locationId: 4,
            name: "Мероприятие шире сетки",
            extClass: "",
            start: moment().add('-10','day').startOf('day').hour(3),
            end: moment().endOf('day').add('10', 'day')
        },
        {
            id: 8,
            locationId: 3,
            name: "00-06",
            extClass: "",
            start: moment().add('1','day').startOf('day').hour(00),
            end: moment().add('1','day').startOf('day').hour(06)
        },
        {
            id: 9,
            locationId: 3,
            name: "07-09",
            extClass: "",
            start: moment().add('1','day').startOf('day').hour(07),
            end: moment().add('1','day').startOf('day').hour(09)
        },
        {
            id: 10,
            locationId: 6,
            name: "Мероприятие на 3 дня",
            extClass: "",
            start: moment().add('1','day').startOf('day').hour(15),
            end: moment().add('4','day').startOf('day').hour(15)
        },
        {
            id: 11,
            locationId: 6,
            name: "Мереоприятие на 3 дня с другим началом",
            extClass: "",
            start: moment().add('2','day').startOf('day').hour(15),
            end: moment().add('5','day').startOf('day').hour(15)
        }
    ];

    //Контекстное меню (Пока не помещал в общий объект, существует как глобальная переменная)
    var dayContextMenu = [
        {
            text: "Создать",
            disabled: false,
            lClick: function(){ 
                console.log('Context button', "Создать", this);
            }
        },
        {
            text: "Переместить",
            disabled: true,
            lClick: function(){ console.log('Context button', "Переместить");}
        },
        {
            text: "Редактировать",
            disabled: true,
            lClick: function(){ console.log('Context button', "Редактировать");}
        },
        {
            text: "Удалить",
            disabled: false,
            lClick: function(){ console.log('Context button', "Удалить");}
        }
    ];

    //События при нажатии кнопок мыши по сетке
    var scheduleEvents = {
        //Левый клик
        lClick: function (e) {
            $('.redBorder').removeClass('redBorder');
            $('.blueBorder').removeClass('blueBorder');
            // $(this).addClass('redBorder');
            if (e.target.className === 'day') {
                addNewEvent(e)
            }
        }
        //Правый клик
        , rClick: function(){
            $('.redBorder').removeClass('redBorder');
            $('.blueBorder').removeClass('blueBorder');
            $(this).addClass('blueBorder');
            DrawContextMenu(dayContextMenu);
            return false;
        }
    }

    //Основной объект, на основе него идет отрисовка
    var scheduleVariable = {
        start: moment().startOf('day'),
        end: moment().endOf('day').add('5', 'day'),
        locations: locations,
        events: events,
        scheduleEvents: scheduleEvents
    }

    function addNewEvent(e) {
        let target = e.target.closest('.day')
        let width = 50
        let ghostEvent = createEventDiv(e, width)

        $(target).append(ghostEvent)
        console.log('event created')
        
        //пока отключил
        //$(document).on('mousemove', rendering)
        //$(document).on('mouseup', renderStop)

        function rendering(e){        
            console.log('rendering')
            let wdth = $(ghostEvent).width()
            $(ghostEvent).css('width', wdth + 1 + 'px')
        }
        function renderStop(e){
            console.log('render stop')
            e.stopPropagation();
            e.preventDefault();
            $(document).off('mousemove', rendering);
            $(document).off('mouseup', renderStop);
        }
    }

    function createEventDiv (e, width) {
        let target = e.target.closest('.day')    
        let start_x = e.pageX - target.getBoundingClientRect().left
        let dateStart = new Date( $(target).find('input[name="Date"]').val() ).toLocaleDateString()
        
        let leftPrc = start_x * 100 / $('.day').width()
        let widthPrc = width * 100 / $('.day').width()

        let ghostEvent = $('<div>', {
            class: 'EventDetailContainer ',
        }).css({
            // left: start_x +'px', 
            top: 0.1 + 'rem',
            // width: width + 'px'
            left: leftPrc,
            width: widthPrc
        });

        let startEventWidth = $(ghostEvent).width()

        let eventInner = $('<div>', {
            class: 'EventDetail'
        }).attr('data-bs-toggle', 'tooltip')
        .attr('data-bs-original-title', 'Новое событие')
        
        let innerText = $('<p>', {
            class: 'm-0 p-0 overflow-hidden text-nowrap fw-bold fs-6'
        }).html('Новое мероприятие')  
        
        // let closeButton = document.createElement('a')
        //                 $(closeButton).html('x')
        //                 $(closeButton).attr('href', '#')
        //                     .attr('onclick', 'deleteNewEvent(this)')
        //                 $(closeButton).css('text-decoration', 'none')
        //                     .css('color', 'white')
        //                     .css('position', 'absolute')
        //                     .css('top', '0px')
        //                     .css('right', '5px')    
        
        $(ghostEvent).append(eventInner)
        let res = getEventDates(ghostEvent, target, width)
        console.log(res)
        let innerDate = $('<p>', {
            class: 'm-0 p-0 overflow-hidden text-nowrap fs-6'
        }).html(res)

        $(eventInner).append(innerText).append(innerDate)

        $(ghostEvent).resizable({
            resizeWidth: true,
            resizeHeight: false,
            onDragStart: null,             
            onDragEnd: null,            
            onDrag: null,           
            eventMinWidth: 4
        });
        
        return ghostEvent
    }

    function getEventDates(event, target, startEventWidth){
        console.log('tut', startEventWidth)
        let dateStart = new Date( $(target).find('input[name="Date"]').val() ).toLocaleDateString()
        let dateArr = dateStart.split('.')

        let minutesInPixel = startEventWidth * 24 * 60 / $('.day').width()
        minutesInPixel = Math.trunc(minutesInPixel)
        console.log('mp', minutesInPixel)
        let w = Number ($(event).css('left').replace('px', '') )
        let dw = $('.day').width()
        let prc = w * 100 / dw
        let time = 24 * 60 * prc / 100
        let hrs = Math.trunc(time / 60)
        hrs = hrs.toString().length === 2 ? hrs : '0' + hrs
        let mins = Math.trunc( Number(time) % 60 )
        mins = mins.toString().length === 2 ? mins : '0' + mins

        let stringResult = ''
        let finalStartDate = new Date(`${dateArr[1]} ${dateArr[0]} ${dateArr[2]} ${hrs}:${mins}:00`)
        stringResult += finalStartDate.toLocaleString().replace(',', '').slice(0,-3)
        let finalEndDate = new Date(finalStartDate.setMinutes(finalStartDate.getMinutes() + Math.trunc(minutesInPixel) ))
        stringResult += ' - '
        stringResult += finalEndDate.toLocaleString().replace(',', '').slice(0,-3)
        console.log(stringResult)
        return stringResult
    }

    //#endregion scheduleParam

    $(document).ready(()=>{
        $('#container').html(DrawSchedule(scheduleVariable));        
    });

    </script>

</html>
