<!doctype html>
<html lang="ru">
  <head>
    <!-- Обязательные метатеги -->
    <title>Hello, world!</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" 
    integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <!-- Resize CSS -->
    <link rel="stylesheet" href="resizeEverything/resizeEverything.css">
  </head>
  <body>
    <!-- Необязательный JavaScript; выберите один из двух! -->

    <!-- Вариант 1: пакет Bootstrap с Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
    <script src="momnet.js"></script>
    <script src="jquery.js"></script>
    
    <!-- Custom scripts -->
    <script src="resizeEverything/resizeEverything.js"></script>
    <!-- Просто блок в который помещаю элементэ -->
    <section id="container" class="container mt-4">
        
    </section>
  </body>
<script>

//#region scheduleDraw

//Места (Объекты левой колонки)
var locations = [
    {
        id: 1,
        name: "Paris"
    },
    {
        id: 2,
        name: "London"
    },
    {
        id: 3,
        name: "Moscow"
    },
    {
        id: 4,
        name: "Berlin"
    },
    {
        id: 5,
        name: "Rostov"
    },
    {
        id: 6,
        name: "Kazan"
    },
    {
        id: 7,
        name: "Vladivostok"
    }
];

//События (полоски в табличке)
var events = [
    {
        id: 1,
        locationId: 1,
        name: "EventName1",
        extClass: "",
        start: moment().add('1','day').startOf('day').hour(9),
        end: moment().add('2','day').startOf('day').hour(9).add('4','hour')
    },
    {
        id: 2,
        locationId: 1,
        name: "EventName2",
        extClass: "",
        start: moment().add('1','day').startOf('day').hour(12),
        end: moment().add('2','day').startOf('day').hour(12)
    },
    {
        id: 7,
        locationId: 2,
        name: "01-23",
        extClass: "",
        start: moment().add('1','day').startOf('day').hour(01),
        end: moment().add('1','day').startOf('day').hour(23)
    },
    {
        id: 3,
        locationId: 2,
        name: "Мероприятие ранее сетки",
        extClass: "",
        start: moment().add('-1','day').startOf('day').hour(12),
        end: moment().add('2','day').startOf('day').hour(12)
    },
    {
        id: 4,
        locationId: 3,
        name: "Мероприятие позднее сетки",
        extClass: "",
        start: moment().add('4','day').startOf('day').hour(3),
        end: moment().endOf('day').add('8', 'day')
    },
    {
        id: 5,
        locationId: 4,
        name: "Мероприятие на всю ширину ровно",
        extClass: "",
        start: moment().startOf('day'),
        end: moment().endOf('day').add('5', 'day'),
    },
    {
        id: 6,
        locationId: 4,
        name: "Мероприятие шире сетки",
        extClass: "",
        start: moment().add('-10','day').startOf('day').hour(3),
        end: moment().endOf('day').add('10', 'day')
    },
    {
        id: 8,
        locationId: 3,
        name: "00-06",
        extClass: "",
        start: moment().add('1','day').startOf('day').hour(00),
        end: moment().add('1','day').startOf('day').hour(06)
    },
    {
        id: 9,
        locationId: 3,
        name: "07-09",
        extClass: "",
        start: moment().add('1','day').startOf('day').hour(07),
        end: moment().add('1','day').startOf('day').hour(09)
    },
    {
        id: 10,
        locationId: 6,
        name: "Мероприятие на 3 дня",
        extClass: "",
        start: moment().add('1','day').startOf('day').hour(15),
        end: moment().add('4','day').startOf('day').hour(15)
    },
    {
        id: 11,
        locationId: 6,
        name: "Мереоприятие на 3 дня с другим началом",
        extClass: "",
        start: moment().add('2','day').startOf('day').hour(15),
        end: moment().add('5','day').startOf('day').hour(15)
    }
];

//Контекстное меню (Пока не помещал в общий объект, существует как глобальная переменная)
var dayContextMenu = [
    {
        text: "Создать",
        disabled: false,
        lClick: function(){ 
            console.log('Context button', "Создать", this);
        }
    },
    {
        text: "Переместить",
        disabled: true,
        lClick: function(){ console.log('Context button', "Переместить");}
    },
    {
        text: "Редактировать",
        disabled: true,
        lClick: function(){ console.log('Context button', "Редактировать");}
    },
    {
        text: "Удалить",
        disabled: false,
        lClick: function(){ console.log('Context button', "Удалить");}
    }
];

//События при нажатии кнопок мыши по сетке
var scheduleEvents = {
    //Левый клик
    lClick: function(){
        $(this).css('border', '1px solid red');        
    }
    //Правый клик
    , rClick: function(){
        $(this).css('border', '1px solid blue');
        DrawContextMenu(dayContextMenu);
        return false;
    }
}

//Основной объект, на основе него идет отрисовка
var schedule = {
    start: moment().startOf('day'),
    end: moment().endOf('day').add('5', 'day'),
    locations: locations,
    events: events,
    scheduleEvents: scheduleEvents
}

$(document).ready(()=>{
    $('#container').html(DrawSchedule(schedule));

    //Включение ресайза после отрисовки
    $(".EventDetail").resizable({
        resizeWidth: true,
        resizeHeight: false,
        onDragStart: null,      // hook into start drag operation (event,$el,opt passed - return false to abort drag)           
        onDragEnd: null,        // hook into stop drag operation (event,$el,opt passed)        
        onDrag: null,           // hook into each drag operation (event,$el,opt passed)
    });
    //Включаю все подсказки при наведении
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
});

//Отрисовывает шахматку и возвращает как html объект
function DrawSchedule(schedule)
{
    console.log('schedule', schedule);
    //Главный блок 

    /*
        первоначально отрисовывается "шапка" таблицы, глобально она не отличается от обычных табличных строк

        далее по очереди отрисовываются строки
        события помещаются в клетку дня в котором они начинаются, и от него и позиционируются
        если начинается ранее первого дня, оно помещается в 1й день

        в каждую ячейку дня помещаются скрытые инпуты ("дата" и "id помещения")
    */


    var container = document.createElement('div');
    container.classList = 'p-0 ScheduleContainer';
    $(container).on('contextmenu', function() {return false;});

    var daysDifference = schedule.end.diff(schedule.start, 'days') + 1; 
    
    //Строка шапки
    var eventRowHeader = document.createElement('div');
    eventRowHeader.classList = 'row LocationRow';
    container.append(eventRowHeader);

    //Помещение
    var locationDivHeader = document.createElement('div');
    locationDivHeader.classList = 'col-3 GridHeader';
    locationDivHeader.innerText = 'Помещения';
    eventRowHeader.append(locationDivHeader);

    //Id помещения
    var locationInputHeader = document.createElement('input');            
    locationInputHeader.type = "hidden";
    locationInputHeader.value = 0;
    locationDivHeader.append(locationInputHeader);

    //Контейнер дат в шапке
    var eventsColumnHeader = document.createElement('div');
    eventsColumnHeader.classList = 'col-9 GridHeader';
    eventRowHeader.append(eventsColumnHeader);

    var headerDate = schedule.start;

    //Отрисовка шапки
    for(var i = 0; i < daysDifference; i++){
        //Колонка день
        var timeZoneHeader = document.createElement('li');
        timeZoneHeader.classList = 'day text-center';
        timeZoneHeader.innerText = moment(headerDate).format('DD.MM.YYYY');
        eventsColumnHeader.append(timeZoneHeader);

        headerDate = moment(headerDate).add('1', 'day');
    }

    //-------------------------------------//
   
    //Отрисовка помещений и событий

    for(var l = 0; l < schedule.locations.length; l++){

        var location = schedule.locations[l];

        //#region Левая колонка
        //Строка помещения
        var eventRow = document.createElement('div');
        eventRow.classList = 'row LocationRow';
        container.append(eventRow);

        //Событие при наведении мыши (закоментил чтоб не мешало)
        // eventRow.addEventListener('mouseenter',(elem)=>{
            
        //     if(this != undefined){

        //         $('.EmptyRow').remove();
        //         $('.noBottomBorder').removeClass('noBottomBorder');

        //         if($(elem.target).find('.GridHeader').length == 0)
        //         {
        //             var currentElem = elem.target;
        //             var relateElement = $(elem.relatedTarget).parents('.LocationRow:first')[0];
                    
        //             console.log('currentElem',currentElem);

        //             if(relateElement == undefined){
        //                 relateElement = elem.relatedTarget;
        //                 console.log('relateElement NULL',relateElement);
        //             }else{
        //                 console.log('relateElement',relateElement);
        //             }

        //             //Главный блок 
        //             var emptyContainer = document.createElement('div');
        //             emptyContainer.classList = 'row LocationRow EmptyRow';
        //             $(emptyContainer).on('contextmenu', function() {return false;});

        //             //Помещение
        //             var emptyLocationDivHeader = document.createElement('div');
        //             emptyLocationDivHeader.classList = 'col-3 LocationsContainer';
        //             emptyContainer.append(emptyLocationDivHeader);

        //             //Id помещения
        //             var emptyLocationInputHeader = document.createElement('input');            
        //             emptyLocationInputHeader.type = "hidden";
        //             emptyLocationInputHeader.value = 0;
        //             emptyLocationDivHeader.append(emptyLocationInputHeader);

        //             //Контейнер дат в шапке
        //             var emptyEventsColumnHeader = document.createElement('div');
        //             emptyEventsColumnHeader.classList = 'col-9 DaysContainer';
        //             emptyContainer.append(emptyEventsColumnHeader);

        //             var emptyDate = schedule.start;

        //             //Отрисовка шапки
        //             for(var i = 0; i < daysDifference; i++){
        //                 //Колонка день
        //                 var timeZone = document.createElement('li');
        //                 timeZone.classList = 'day';
        //                 emptyEventsColumnHeader.append(timeZone);
                        
        //                 var dateInfo = document.createElement('input');
        //                 dateInfo.type = 'hidden';
        //                 dateInfo.name = 'Date';
        //                 dateInfo.value = emptyDate.toISOString();
        //                 timeZone.append(dateInfo);

        //                 var locationInfo = document.createElement('input');
        //                 locationInfo.type = 'hidden';
        //                 locationInfo.name = 'LocationId';
        //                 locationInfo.value = location.id ;
        //                 timeZone.style = 'min-height: 3.2rem;';

        //                 emptyDate = moment(headerDate).add('1', 'day');
        //             }


        //             $(currentElem).after(emptyContainer);
        //             $(currentElem).addClass('noBottomBorder');

        //         }

        //         console.log(elem);
        //     }
            
        // });

        //Помещение
        var locationDiv = document.createElement('div');
        locationDiv.classList = 'col-3 LocationsContainer';
        locationDiv.innerText = location.name;
        eventRow.append(locationDiv);

        //Id помещения
        var locationInput= document.createElement('input');            
        locationInput.type = "hidden";
        locationInput.value = location.id;
        locationDiv.append(locationInput);

        //#endregion

        //#region Правая колонка
        //Столбец c расписанием    
        var eventsColumn = document.createElement('div');
        eventsColumn.classList = 'col-9 DaysContainer';
        eventRow.append(eventsColumn);
        
        var date = moment(schedule.start);

        //Уже отрисованные элементы в этой строке (нужен для определения отступа сверху)
        var alreadyPushedEvents = [];

        //Цикл отрисовки сетки дней
        for(var i = 0; i < daysDifference; i++){
            //Колонка день
            var timeZone = document.createElement('li');
            timeZone.classList = 'day';            
            timeZone.addEventListener('click', schedule.scheduleEvents.lClick);
            timeZone.addEventListener('contextmenu', schedule.scheduleEvents.rClick);
            timeZone.style = 'min-height: 3.2rem;';
            eventsColumn.append(timeZone);
            
            var dateInfo = document.createElement('input');
            dateInfo.type = 'hidden';
            dateInfo.name = 'Date';
            dateInfo.value = date.toISOString();
            timeZone.append(dateInfo);

            var locationInfo = document.createElement('input');
            locationInfo.type = 'hidden';
            locationInfo.name = 'LocationId';
            locationInfo.value = location.id ;
            timeZone.append(locationInfo);

            //Получаем список событий начинающийся в этот день
            var events = schedule.events.filter(
                x => x.locationId == location.id 
                && x.start >= date.startOf('day')
                && x.start <= date.endOf('day')
            );

            //Получаем список событий начинающийся в этот день и ранее (если начало выходит за диапазон отрисовки)
            if(i == 0){
                events = schedule.events.filter(
                    x=>x.locationId == location.id 
                    && x.start <= date.endOf('day')
                );
            }
            
            //Отрисовка мероприятий в этот день
            if(events.length > 0){
                for(var e = 0; e < events.length; e++){
                    
                    var currEvent = events[e];

                    //Отступ сверху
                    var top = alreadyPushedEvents.filter(x=>x.locationId == currEvent.locationId && x.start < currEvent.end && x.end > currEvent.start).length;

                    //Деталь мероприятия (полоска)
                    var eventProgress = document.createElement('div');
                    eventProgress.classList = 'EventDetail ' + currEvent.extClass;
                    eventProgress.setAttribute('data-bs-toggle','tooltip');
                    eventProgress.setAttribute('title', currEvent.name + ' \r\n' + currEvent.start.format('DD.MM.YYYY HH:mm') + ' - ' + currEvent.end.format('DD.MM.YYYY HH:mm'));

                    //Расчет длины события (не лезь сюда, оно тебя сожрет) 
                    if(currEvent.start >= schedule.start && currEvent.end <= schedule.end)
                    {
                        eventProgress.style.width = (currEvent.end.diff(currEvent.start, 'day', true) * 100) + '%';
                        eventProgress.style.left = (currEvent.start.diff(date.startOf('day'), 'day', true) * 100) + '%';
                    }
                    else if(currEvent.start < schedule.start && currEvent.end > schedule.end)
                    {
                        eventProgress.style.width = (schedule.end.diff(schedule.start.startOf('day'), 'day', true) * 100) + '%';
                        eventProgress.style.left = '0%';
                    }
                    else if(currEvent.start >= schedule.start )
                    {
                        eventProgress.style.width = (schedule.end.diff(currEvent.start, 'day', true) * 100) + '%';
                        eventProgress.style.left = (currEvent.start.diff(date.startOf('day'), 'day', true) * 100) + '%';
                    }
                    else
                    {
                        eventProgress.style.width = (currEvent.end.diff(schedule.start, 'day', true) * 100) + '%';
                        eventProgress.style.left = '0%';
                    }

                    eventProgress.style.top = (top * 3.1 + 0.1) + 'rem';
                    timeZone.append(eventProgress);

                    top++;

                    //Увеличиваем "родителя"
                    timeZone.style = 'min-height: ' + (top * 3.1 + 0.1) + 'rem;';

                    //Название мероприятия
                    var eventName = document.createElement('p');
                    eventName.classList = 'm-0 p-0 overflow-hidden text-nowrap fw-bold fs-6';
                    eventName.innerText = currEvent.name;
                    eventProgress.append(eventName);
                    
                    //Продолжительность мероприятия
                    var eventDuration = document.createElement('p');
                    eventDuration.classList = 'm-0 p-0 overflow-hidden text-nowrap fs-6';
                    eventDuration.innerText = currEvent.start.format('DD.MM.YYYY HH:mm') + ' - ' + currEvent.end.format('DD.MM.YYYY HH:mm');
                    eventProgress.append(eventDuration);

                    //Добавляем в отрисованные
                    alreadyPushedEvents.push(currEvent);
                }
            }

            date = moment(date).add('1', 'day');
        }

        //#endregion
    }

    

    //-------------------------------------//
    
    //Добавляем события на основной элемент
    $(container).find('div').each(()=>{
        //Удаляем контекстное меню если кликнули мимо
        $(this).on('click',()=>{
            $('.daysContextMenu').remove();
        });
        //Удаляем строчку расширения строки если курсор вышел за границы шахматки
        $(this).on('mouseover',()=>{
            $('.EmptyRow').remove();
            $('.noBottomBorder').removeClass('noBottomBorder');
        });
    });

    return container;
}

//#endregion

//Отрисовка контекстного меню(элементы контекста)
//Возможно как доп параметр надо передавать объект по которому кликнули, для более корректной отрисовки
function DrawContextMenu(contextContent){

    $('.daysContextMenu').remove();

    var menuContainer = $('<div>',{
        class: 'list-group daysContextMenu',
    }).css({
        // получаем координаты клика и делаем их координатами меню
        left: event.pageX+'px', 
        top: event.pageY+'px' 
    });
    
    for(var i = 0; i < contextContent.length; i++){
        var option = contextContent[i];

        var menuButton = $('<button>',{
            type: 'button',
            class: 'list-group-item list-group-item-action',
            disabled: option.disabled
        }).on('click', option.lClick);

        menuContainer.append(menuButton);

        var menuSpan = $('<span>',{
            class: 'contextSpan',
            text: option.text
        });

        menuButton.append(menuSpan);
    }

    $('body').append(menuContainer);
}
</script>
<style>

    #container{
        position: relative;
    }

    .LocationsContainer, .DaysContainer, .GridHeader{
        background-color: #ffffff;
        display: inline-flex;
        margin: 0;
        padding: 0.25rem;
        padding-left: 0.5rem;
    }

    .LocationRow{
        border: 1px solid #F5F5F5;
    }
    
    .LocationsContainer{
        background-color: #F5F5F5;
        padding: 0.25rem;
        padding-left: 0.5rem;
        vertical-align: middle;
    }
    
    .day{
        list-style-type: none;
        padding-left: 0;
        border: 0px solid black;
        width: 100%;
        height: 100%;
        border-collapse: collapse;
        position: relative;
    }

    .DaysContainer{
        padding: 0;
        
    }

    .DaysContainer .day:nth-child(even){
        background-color: #F5F5F5;
    }

    .EventDetail{
        position: absolute;
        background-color: #6495ED;
        height: 3rem;
        padding-left: 0.5rem;
        z-index: 1;
    }

    .EventDetail:hover{
        background-color: #6495ED50;
    }
    
    .daysContextMenu{
        position: absolute;
        z-index: 2;
    }

    .daysContextMenu button{
        padding: 0;
        overflow: hidden;
    }

    .daysContextMenu button:hover{
        background-color: #6495ED;
        color: #ffffff;
    }

    .contextSpan{
        font-size: 0.7rem;
        white-space: nowrap;
        margin: 0.25rem 0.5rem;
    }
    
    .EmptyRow{
        border-top: none;
    }

    .noBottomBorder{
        border-bottom: none;
    }
</style>

</html>
